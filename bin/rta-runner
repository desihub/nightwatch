#!/usr/bin/env python

"""
Real Time Analysis Runner

TODO: most of this should move into a module file, not a script
"""

import sys, os, re, time
import multiprocessing as mp
import subprocess
import fitsio

from rta.qa import QARunner
from rta.plots.amp import write_amp_qa_html

import desispec.scripts.preproc
import desiutil.log

def find_latest_expdir(basedir):
    '''
    finds the latest basedir/YEARMMDD/EXPID without traversing the whole tree
    
    Returns directory, or None if no matching directories are found
    '''
    #- Search for most recent basedir/YEARMMDD
    for dirname in sorted(os.listdir(basedir), reverse=True):
        nightdir = os.path.join(basedir, dirname)
        if re.match('20\d{6}', dirname) and os.path.isdir(nightdir):
            break
    else:
        return None  #- no basename/YEARMMDD directory was found
    
    for dirname in sorted(os.listdir(nightdir), reverse=True):
        expdir = os.path.join(nightdir, dirname)
        if re.match('\d{8}', dirname) and os.path.isdir(expdir):
            break
    else:
        return None  #- no basename/YEARMMDD/EXPID directory was found
    
    return expdir    

def which_cameras(rawfile):
    '''
    Returns list of cameras found in rawfile
    '''
    cameras = list()
    with fitsio.FITS(rawfile) as fx:
        for hdu in fx:
            extname = hdu.get_extname().upper()
            if re.match('[BRZ][0-9]', extname):
                cameras.append(extname.lower())
    
    return cameras

def run_preproc(rawfile, outdir, ncpu=None):
    '''TODO: document'''
    if not os.path.exists(datafile):
        raise ValueError("{} doesn't exist".format(datafile))
        
    cameras = which_cameras(rawfile)
    header = fitsio.read_header(rawfile, 0)
    
    arglist = list()
    for camera in cameras:
        args = ['--infile', datafile, '--outdir', outdir, '--cameras', camera]
        arglist.append(args)

    if ncpu is None:
        ncpu = max(1, mp.cpu_count()//2)  #- no hyperthreading

    pool = mp.Pool(ncpu)
    pool.map(desispec.scripts.preproc.main, arglist)
    
    return header

def run_qproc(rawfile, outdir, ncpu=None):
    '''
    Determine the flavor of the rawfile, and run qproc with appropriate options
    
    returns header of HDU 0 of the input rawfile
    '''
    hdr = fitsio.read_header(rawfile, 0)
    flavor = hdr['FLAVOR'].rstrip().upper()
    night = hdr['NIGHT']
    expid = hdr['EXPID']
    
    indir = os.path.abspath(os.path.dirname(rawfile))
    
    arglist = list()
    cameras = which_cameras(rawfile)
    for camera in cameras:
        outfiles = dict(
            rawfile = rawfile,
            fibermap = '{}/fibermap-{:08d}.fits'.format(indir, expid),
            preproc = '{}/preproc-{}-{:08d}.fits'.format(outdir, camera, expid),
            psf = '{}/psf-{}-{:08d}.fits'.format(outdir, camera, expid),
            qframe = '{}/qframe-{}-{:08d}.fits'.format(outdir, camera, expid),
            qcframe = '{}/qcframe-{}-{:08d}.fits'.format(outdir, camera, expid),
            qsky = '{}/qsky-{}-{:08d}.fits'.format(outdir, camera, expid),
        )

        if flavor == "SCIENCE":
            cmd = "desi_qproc -i {rawfile} --fibermap {fibermap} --cam {camera}"
            cmd += " --output-preproc {preproc}"
            cmd += " --shift-psf --output-psf {psf}"
            cmd += " --output-rawframe {qframe}"
            cmd += " --apply-fiberflat --skysub --output-skyframe {qsky}"
            cmd += " --fluxcalib --outframe {qcframe}"
        elif flavor == "ARC":
            cmd = "desi_qproc -i {rawfile} --cam {camera}"
            cmd += " --output-preproc {preproc}"
            cmd += " --shift-psf --compute-lsf-sigma --output-psf {psf}"
            cmd += " --output-rawframe {qframe}"
        elif flavor == "FLAT":
            cmd = "desi_qproc -i {rawfile} --cam {camera}"
            cmd += " --output-preproc {preproc}"
            cmd += " --shift-psf --output-psf {psf}"
            cmd += " --output-rawframe {qframe}"
            cmd += " --compute-fiberflat --output-flatframe {qflatframe}"
        elif flavor in ("ZERO", "DARK"):
            cmd = "desi_qproc -i {rawfile} --cam {camera}"
            cmd += " --output-preproc {preproc}"
        else:
            log = desiutil.log.get_logger()
            log.error('{}/{}: unrecognized flavor {}'.format(night, expid, flavor))
            cmd = "desi_qproc -i {rawfile} --cam {camera}"
            cmd += " --output-preproc {preproc}"

        fullcmd = cmd.format(camera=camera, **outfiles)
        arglist.append(fullcmd.split())    

    if ncpu is None:
        ncpu = max(1, mp.cpu_count()//2)  #- no hyperthreading

    if ncpu > 1:
        pool = mp.Pool(ncpu)
        pool.map(subprocess.call, arglist)
    else:
        for args in arglist:
            print('\n-- RUNNING: ' + ' '.join(args) + '\n')
            subprocess.call(args)

    return hdr

#-------------------------------------------------------------------------

import argparse

parser = argparse.ArgumentParser(usage = "{prog} [options]")
parser.add_argument("--datadir", type=str,  help="look for new data in datadir/YEARMMDD/EXPID", required=True)
parser.add_argument("-o", "--outdir", type=str,  help="output directory", required=True)
# parser.add_argument("-v", "--verbose", action="store_true", help="some flag")

args = parser.parse_args()

qarunner = QARunner()

processed = set()
while True:
    expdir = find_latest_expdir(args.datadir)
    if expdir is None:
        continue

    night, expid = expdir.split('/')[-2:]
    rawfile = os.path.join(expdir, 'desi-{}.fits.fz'.format(expid))
    if expdir not in processed and os.path.exists(rawfile):
        outdir = '{}/{}/{}'.format(args.outdir, night, expid)
        if os.path.exists(outdir):
            print('Skipping previously processed {}/{}'.format(night, expid))
            processed.add(expdir)
            continue
        else:
            os.makedirs(outdir)
        
        print('Running qproc on {}'.format(rawfile))
        # header = run_preproc(rawfile, outdir)
        header = run_qproc(rawfile, outdir, ncpu=1)
        
        print('Running QA on {}/{}'.format(night, expid))
        qadata = qarunner.run(indir=outdir, outdir=outdir)
        print('Generating plots for {}/{}'.format(night, expid))
        
        html_amp = '{}/qaAmp-{}.html'.format(outdir, expid)
        write_amp_qa_html(qadata['PER_AMP'], html_amp, header)
        
        print('Wrote {}'.format(html_amp))
        
        processed.add(expdir)
    time.sleep(2)
